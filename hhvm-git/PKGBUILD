# Maintainer: Yen Chi Hsuan <yan12125 at gmail dot com>
# Maintainer: Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
# Contributor: James Miller <james@pocketrent.com>

_pkgname=hhvm
pkgname=${_pkgname}-git
pkgver=20141219
pkgrel=1
pkgdesc="Virtual Machine, Runtime, and JIT for PHP"
arch=('x86_64')
url="http://hhvm.com"
license=('PHP')
depends=('boost-libs' 'google-glog' 'libmysqlclient' 'libmemcached' 'pcre' 'gd'
         'libxml2' 'libxslt' 'intel-tbb' 'libmcrypt' 'oniguruma' 'curl'
         'libdwarf' 'imagemagick' 'libedit')
makedepends=('git' 'cmake' 'gcc' 'boost' 'python2')
source=("git+https://github.com/facebook/hhvm"
        "git+https://github.com/hhvm/hhvm-third-party"
        "git+https://github.com/facebook/folly"
        "git+https://github.com/facebook/fbthrift"
        'hhvm.tmpfile'
        'hhvm@.service')
sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'cabf505fa85e33d7149f90fae95c6f67d5148895fc6efa353b21a3b31c1c3ec6'
            'ac1d695805b3a0223fc33139ae941a00f8e78db321a943c51aa966d2e12e342b')
install=hhvm.install
options+=('!buildflags') # default flags cause libdwarf failed to link

pkgver() {
    cd "${srcdir}/${_pkgname}"
    git log -1 --format='%cd' --date=short | tr -d -- '-'
}

prepare() {
    cd "${srcdir}/${_pkgname}"

    git submodule init
    git config submodule.third-party.url "${srcdir}/hhvm-third-party"
    git submodule update

    cd third-party
    git submodule init
    git config submodule.folly.url "${srcdir}/folly"
    git config submodule.thrift/src.url "${srcdir}/fbthrift"
    git submodule update
}

build() {
    cd "$srcdir"/${_pkgname}
    msg2 "Building hhvm"

    # comment for tests
    HPHP_NOTEST=1 \
    cmake \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_PREFIX_PATH="$srcdir" \
        .

    make
}

# check() {
#     cd "$srcdir"/$pkgname-HHVM-$pkgver/hphp/test
#     ./run --threads 8 quick
# }

package() {
    cd "${srcdir}/${_pkgname}"
    make DESTDIR="$pkgdir/" install

    cd "$srcdir"
    install -Dm644 hhvm.tmpfile "$pkgdir"/usr/lib/tmpfiles.d/hhvm.conf
    install -Dm644 hhvm@.service "$pkgdir"/usr/lib/systemd/system/hhvm@.service

    install -dm755 -o http "$pkgdir"/var/log/hhvm
}

